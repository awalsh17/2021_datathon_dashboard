# app.R 

# Source file that reads in data, misc. set ups, and other static things
source("source.R")


# ui ----
ui <- dashboardPage(
  
  # Top level ----
  title = "R-Ladies Datathon 2021",
  skin = "purple",
  header = dashboardHeader(title = "R-Ladies Philly"),
  
  # Sidebars ----
  ## left sidebar ====
  sidebar = dashboardSidebar(
    shinydashboard::sidebarMenu(
      menuItem("Sentences", tabName = "SentenceTab", icon = icon("warning-sign", lib = "glyphicon")),
      menuItem("Bail", tabName = "BailTab", icon = icon("dollar")),
      menuItem("Basic Judge Info", tabName = "JudgeTab", icon = icon("user")),
      menuItem("About", tabName = "AboutTab", icon = icon("info"))
    )
  ),
  
  ## right sidebar ====
  controlbar = dashboardControlbar(
    controlbarMenu(
      controlbarItem("Controls",
                     actionBttn("Debugger", "Debug", block = TRUE, color = "danger")
      )
    )
  ),
  
  body = dashboardBody(
    
    tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "datathon-2021.css")),
    
    tabItems(
      
      
  # Judge tab ----
  tabItem(tabName = "JudgeTab",
              
              ## main page ====
              fluidPage(
                
              ### top row ####
              fluidRow(
                  tabBox(id = "PlotsTabset", width = 12,
                         
              ##### judge first plot panel ####
              tabPanel(title = "Common Offenses by Judge", value = "Judge1Tab",
                          fluidRow(
                            column(width = 10, plotOutput("JudgePlot1Output")),
                            column(width = 2, 
                                    selectInput('judge', 'Judge', judge_options),
                                    sliderInput('year', 'Year Range (disposition date)', 
                                               min=2010, max=2020,
                                              value=c(2010, 2020), step=1, 
                                              round=T, sep="")
                                    )
                                  )
                         ),
                         
              ##### judge second plot panel ####
                 tabPanel(title = "Add Here", value = "Judge2Tab",
                                  fluidRow(
                                    column(width = 10),
                                    column(width = 2)
                                  )
                         )
                  )
                ),
                
              
              ### bottom row ####
              fluidRow(
                  column(width = 12, reactableOutput("TableOutputJudge1"))
                )
              )
      ),
      
      
      
  # Bail tab ----
      tabItem(tabName = "BailTab",
              
              ## main page ====
              fluidPage(
                
              ### top row ####
              fluidRow(
                  tabBox(id = "PlotsTabset", width = 12,
                         
                         ##### bail plot panel 1 ####
                         tabPanel(title = "Cumulative total of bail changes", value = "BailPlot1Tab",
                         fluidRow(
                           column(width = 12, girafeOutput("BailPlot1Output", height = NULL))
                         ),
                         fluidRow(
                           column(width = 12,
                                  "This plot shows the cumulative total of bail increases and decreases by a given judge.
          Increases equal 1 while decreases equal -1. Judges that increase bail amounts more often
          than they decrease them have a positive value, while the opposite is true for judges
          that decrease bail amounts more often. The bar fill indicates the total number of 
          bail changes (both increases and decreases"
                           ))
                        ),
                        ##### bail plot panel 2 ####
                        tabPanel(title = "Total # of Bail Amount Changes", value = "BailPlot2Tab",
                       fluidRow(
                         column(width = 10, plotOutput("BailPlot2Output")),
                         column(width = 2,
                                pickerInput('bail_judges', 
                                            'Judges of Interest', 
                                            choices = unique(bail_net_change_by_judge$judge),
                                            selected = c("Judge Ann Butchart", "Judge Abbe Fletman"), 
                                            options = list(`actions-box` = TRUE), 
                                            multiple = TRUE))
                       ),
                       fluidRow(
                         column(width = 12,
                                "This plot shows the cumulative total of bail increases and decreases by a given judge.
          Increases equal 1 while decreases equal -1. Judges that increase bail amounts more often
          than they decrease them have a positive value, while the opposite is true for judges
          that decrease bail amounts more often. The bar fill indicates the total number of 
          bail changes (both increases and decreases"
                         )),
                       ### bottom row ####
                       fluidRow(
                         column(width = 12, 
                                reactableOutput("TableOutputBail1")
                         )
                       )
                      )
                  )
              )
              )
      ),
      
      # Sentences tab ----
      tabItem(tabName = "SentenceTab",

              ## main page ====
              fluidPage(

                ### top row ####
                fluidRow(
                  tabBox(id = "PlotsTabset", width = 12,

              ##### Sentence first plot panel ####
              tabPanel(title = "Visualization of Sentence Length", 
                       value = "SenPlot1Tab",
                                  fluidRow(
                                    column(width = 2,style = "height:800px",
                                           pickerInput('judges_of_interest', 
                                                       'Judges of Interest', 
                                                       choices = unique(merged.narrow$Judge),
                                                       selected = unique(merged.narrow$Judge), 
                                                       options = list(`actions-box` = TRUE), 
                                                       multiple = TRUE),
                                           textInput("crime_descriptions","Crime Description",
                                                     value = ""),
                                           textInput("title_descriptions","Title Description",
                                                     value = ""),
                                           textInput("disposition_methods","Disposition Method",
                                                     value = ""),
                                           pickerInput("races","Race", 
                                                       choices = unique(merged.narrow$race), 
                                                       multiple = TRUE, 
                                                       selected = unique(merged.narrow$race),
                                                       options = list(`actions-box` = TRUE)),
                                           numericInput("nfactors","Number Categories",
                                                        value = 6, min = 1, max = 10),
                                           selectInput("x.axis","On X Axis",
                                                       choices = options, 
                                                       selected = "Chapter_Description"),
                                           selectInput("facet","Separate By", 
                                                       choices = options, selected = "Judge")
                                    ),
                                    column(width = 10, style = "height:800px",
                                           align = "left",
                                           plotOutput("PlotSenOutput", height = "800px"))
                                  ),
                       ### bottom row tab 1 ####
                       fluidRow(
                         column(width = 12, reactableOutput("TableOutputSentences1"))
                       )
                                  
                         ),

                         ##### Sentence Second plot panel ####
                         tabPanel(title = "Sentence by judge and offense", value = "SenPlot2Tab",
                                  fluidRow(
                                    column(width = 10, plotOutput("SenPlot2Output")),
                                    column(width = 2,
                                           selectInput("description", 
                                                       "Offense Description", 
                                                       description_options, 
                                                       selected = description_options[1:3],
                                                       multiple = FALSE),
                                           checkboxInput("facet_grade", "Separate by Grade",FALSE),
                                           selectInput('grade', 
                                                       "Grade", 
                                                       unique(merged$grade_backfilled), 
                                                       selected = unique(merged$grade_backfilled),
                                                       multiple = TRUE),
                                           selectInput('judge_sentence', 'Judge', judge_options))
                                  ),
                                  ### middle row with a legend ###
                                  fluidRow(
                                    column(width = 12, 
      "The above plot compares sentencing behavior for a selected judge compared to all other judges. The y-axis is the percent of occurences for a given sentence type across all observations of that offense. The numbers that appear above the bars are the total number of occurences for that sentence type. Keep in mind that the data used here is only for offenses that had an associated sentence and not the occurences of these offenses on dockets without sentences (while other offenses on the same docket had sentences). This visualization does not consider other factors about the docket such as other crimes, the defendants record, or the disposition method.")
                                  ),
      hr(),
                                  ### another row with another plot ####
                                  fluidRow(
                                      column(width = 10, plotOutput("SenPlot2bOutput"))
                                  ),
                                  fluidRow(
                                       column(width = 12, 
               "The above plot compares sentencing behavior for a selected judge compared to all other judges. The median values are shown.")
                                  ),
      hr(),
                                  ### bottom row tab 2 ####
                                  fluidRow(
                                    column(width = 12, reactableOutput("TableOutputSentences2"))
                                  )
                         ),
              ##### Sentence 3 plot panel ####
              tabPanel(title = "Sentence type by race", value = "SenPlot3Tab",
                       fluidRow(
                         column(width = 2,
                                pickerInput("race_sentence","Race", 
                                            choices = unique(dispo_det$race), 
                                            multiple = TRUE, 
                                            selected = c("White","Black"),
                                            options = list(`actions-box` = TRUE))
                         ),
                         column(width = 10, plotOutput("SenPlot3Output")),
                         
                       ### bottom row tab 2 ####
                       fluidRow(
                         column(width = 12)
                       )
              )
                  )
                )
              )
      )),
      
      
      # About tab ----
      tabItem(tabName = "AboutTab",
              fluidPage(
                fluidRow(
                  column(width = 2),
                  column(width = 10)
                )
              )
      )
      
    )
    
  ),
  
  
  
  
  # misc ----
  footer = dashboardFooter()
  
 
  
)

server <- function(input, output) {
  #
  # The data ----
  # - Might wanna think about data structure for multiple plot dfs
  # - Packing dfs into a list in a single reactive(Val)?
  
  
  # JudgePlot1 data
  data_judge_filter <- reactive({
    merged %>% 
      filter(judge==input$judge,
             disposition_year >= input$year[1] & disposition_year <= input$year[2])
  })
  
  # SentencePlot2 data
  # This is just for the reactable - choose selected judge
  data_offense_filter <- reactive({
    merged %>% 
      filter(description_clean %in% input$description,
             grade %in% input$grade,
             judge==input$judge_sentence)
  })
  
  sentence_length_summary <- reactive({
    if(input$facet_grade){
    merged %>% 
      filter(description_clean %in% input$description,
             grade %in% input$grade) %>% 
      mutate(select_judge = ifelse(judge==input$judge_sentence,input$judge_sentence,"Other" )) %>% 
      group_by(grade, description_clean, select_judge, sentence_type) %>% 
    summarise(median_min_days = median(min_period_days, na.rm = T),
              mean_min_days = mean(min_period_days, na.rm = T),
              median_max_days = median(max_period_days, na.rm = T),
              mean_max_days = mean(max_period_days, na.rm = T),
              .groups = "drop") 
    } else {
      merged %>% 
        filter(description_clean %in% input$description,
               grade %in% input$grade) %>% 
        mutate(select_judge = ifelse(judge==input$judge_sentence,input$judge_sentence,"Other" )) %>% 
        group_by(description_clean, select_judge, sentence_type) %>% 
        summarise(median_min_days = median(min_period_days, na.rm = T),
                  mean_min_days = mean(min_period_days, na.rm = T),
                  median_max_days = median(max_period_days, na.rm = T),
                  mean_max_days = mean(max_period_days, na.rm = T),
                  .groups = "drop") 
    }
  })
  
  sentence_type_summary <- reactive({
    if (input$facet_grade){
      merged %>% 
        filter(description_clean %in% input$description,
               grade %in% input$grade) %>% 
        mutate(select_judge = ifelse(judge==input$judge_sentence,input$judge_sentence,"Other" )) %>% 
        group_by(grade, description_clean, select_judge) %>% 
        count(sentence_type) %>% 
        mutate(prop_sentence_type = n/sum(n)) %>% 
        ungroup() %>% 
        mutate(axis_label = paste0(sentence_type, " (n=", as.character(n), ")"))
    } else{
      merged %>% 
        filter(description_clean %in% input$description,
               grade %in% input$grade) %>% 
        mutate(select_judge = ifelse(judge==input$judge_sentence,input$judge_sentence,"Other" )) %>% 
        group_by(description_clean, select_judge) %>% 
        count(sentence_type) %>% 
        mutate(prop_sentence_type = n/sum(n)) %>% 
        ungroup() %>% 
        mutate(axis_label = paste0(sentence_type, " (n=", as.character(n), ")"))
    }
    
  })
  
  
  # Sentence plot 1 data
  filtered.data <- reactive({
    merged.narrow %>%
      #filter based on selection
      dplyr::mutate(in_select_judges = ifelse(Judge %in% input$judges_of_interest, 
                                              Judge, "Other Judges")) %>%
      filter(race %in% input$races,
             stringr::str_detect(tolower(statute_description),
                                       paste(tolower(input$crime_descriptions), collapse = "|") ),
             stringr::str_detect(tolower(Title_Description),
                                paste(tolower(input$title_descriptions), collapse = "|") ),
             stringr::str_detect(tolower(disposition_method),
                                paste(tolower(input$disposition_methods), collapse = "|") )
             
             )

  })
  
  # Roy bail data filtered
  bail_filtered <- reactive({
    bail_net_change_by_judge %>% 
      filter(judge %in% input$bail_judges) 
  })
  
  # Kulbir data filtered sentences #3
  dispo_race<- reactive({
    dispo_det %>% filter(race %in% input$race_sentence) 
  })
  
  #
  # Plots -----
  #
  # Judge plot 1
  output$JudgePlot1Output <- renderPlot({
    data_judge_filter() %>% 
      dplyr::mutate(description_clean = forcats::fct_lump(description_clean, n= 5)) %>% 
      ggplot(aes(x=description_clean)) + 
      geom_bar(position = "dodge") + 
      labs(title="What are the most common offenses adjudicated?",
           subtitle = paste0("Selected judge: ", input$judge),
           x = "Offense") + 
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) + 
      theme(axis.text.x = element_text(size=5)) + 
      NULL
    
  }, res = 150)
  
  

  # Sentences Plot 1
  output$PlotSenOutput <- renderPlot({
    filtered.data() %>%
      dplyr::mutate(on.x.axis = forcats::fct_lump_n(eval(parse(text = input$x.axis)), n = input$nfactors)) %>% #head()
      dplyr::mutate(to.facet = forcats::fct_lump_n(eval(parse(text = input$facet)), n = input$nfactors)) %>%
      ggplot(aes(x = on.x.axis, 
                 y = Confinement_Time, 
                 fill = race, 
                 size = Age_at_Arrest, 
                 shape = gender)) +
      geom_jitter(pch = 21, width = 0.3) + 
      scale_size_continuous(name="Age_at_Arrest", range = c(.2,3)) +
      theme_minimal() + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.text = element_text(size = 5)) +
      labs(y="Max Confinement Time (Years)", x = paste(input$x.axis)) +
      guides(fill = guide_legend(override.aes = list(size = 3))) + 
      scale_x_discrete(labels = scales::wrap_format(20)) + 
      scale_fill_discrete(labels = scales::wrap_format(10)) +
      facet_wrap(.~to.facet)
  }, res = 150)
  
  
  # Sentence plot on panel 2 (old)
  # output$SenPlot2Output <- renderPlot({
  #   data_offense_filter() %>% 
  #     dplyr::filter(sentence_type %in% c("Confinement","Probation"),
  #                   !is.na(max_period_days)) %>% 
  #     ggplot(
  #       aes(x = sentence_type,
  #           y = max_period_days 
  #       )) +
  #     geom_boxplot(
  #       alpha = .5,
  #       show.legend = FALSE
  #     ) +
  #     geom_jitter(
  #       alpha = .5,
  #       height = 0,
  #       width = 0.2,
  #       show.legend = FALSE
  #     ) + 
  #     labs(
  #       y = "Maximum Sentence (days)",
  #       x = "Sentence Type",
  #       title = "Maximum Sentence"
  #     )
  # }, res = 150)
  
  # Sentence plot on tab2 (new)
  output$SenPlot2Output <- renderPlot({
    if (input$facet_grade){
      sentence_type_summary() %>% 
        ggplot(aes(x=sentence_type, 
                   y = 100*prop_sentence_type, 
                   fill=select_judge)) + 
        geom_bar(stat = "identity", position = "dodge") + 
        geom_text(aes(label=n), size=2,
                  position=position_dodge(width=0.9), vjust=-0.25) + 
        facet_grid(.~grade+description_clean, scales = "free_x",space="free_x",
                   labeller = labeller(description_clean = label_wrap_gen(25)))+
        labs(title="Sentence type by judge and offense",
             subtitle = "Selected judge: Rayford A. Means",
             x = "", y = "Percentage",
             fill = "Judge",
             caption = "Only considering offenses with a disposition") + 
        scale_fill_manual(values = c("lightgray","goldenrod3")) + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle=90, hjust=1,vjust=0.5))
    } else{
      sentence_type_summary() %>% 
        ggplot(aes(x=sentence_type, 
                   y = 100*prop_sentence_type, 
                   fill=select_judge)) + 
        geom_bar(stat = "identity", position = "dodge") + 
        geom_text(aes(label=n), size=2,
                  position=position_dodge(width=0.9), vjust=-0.25) + 
        facet_grid(.~description_clean, scales = "free_x",space="free_x",
                   labeller = labeller(description_clean = label_wrap_gen(25)))+
        labs(title="Sentence type by judge and offense",
             x = "", y = "Percentage",
             caption = "Only considering offenses with a disposition") + 
        scale_fill_manual(values = c("lightgray","goldenrod3")) + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle=90, hjust=1,vjust=0.5))
    }
    
  }, res = 150)
  
  output$SenPlot2bOutput <- renderPlot({
    if (input$facet_grade){
    sentence_length_summary() %>% 
      filter(sentence_type %in% c("Confinement","Probation")) %>% 
      tidyr::pivot_longer(ends_with("days")) %>% 
      filter(name %in% c("median_min_days","median_max_days")) %>% 
      mutate(group = paste(select_judge,sentence_type)) %>% 
      ggplot( aes(x=sentence_type, 
                  y = value,
                  group = group,
                  color=select_judge)) + 
      geom_point(position = position_dodge(width=0.4), size = 3) + 
      geom_line(position = position_dodge(width=0.4), 
                size=1.5, alpha=0.7) +
      facet_grid(.~grade+description_clean, scales = "free_x",space="free_x",
                 drop=T,
                 labeller = labeller(grade_desc = label_wrap_gen(25)))+
      labs(title="Sentence length by judge and offense",
           x = "", y = "Median Sentence min/max (days)",
           caption = "Only considering offenses with a disposition") + 
      scale_color_manual(values = c("lightgray","goldenrod3")) + 
      coord_flip() + 
      theme_minimal() + 
      theme(axis.text.x = element_text(angle=90, hjust=1,vjust=0.5))
    } else{
      sentence_length_summary() %>% 
        filter(sentence_type %in% c("Confinement","Probation")) %>% 
        tidyr::pivot_longer(ends_with("days")) %>% 
        filter(name %in% c("median_min_days","median_max_days")) %>% 
        mutate(group = paste(select_judge,sentence_type)) %>% 
        ggplot( aes(x=sentence_type, 
                    y = value,
                    group = group,
                    color=select_judge)) + 
        geom_point(position = position_dodge(width=0.4), size = 3) + 
        geom_line(position = position_dodge(width=0.4), 
                  size=1.5, alpha=0.7) +
        facet_grid(.~description_clean, scales = "free_x",space="free_x",
                   drop=T,
                   labeller = labeller(grade_desc = label_wrap_gen(25)))+
        labs(title="Sentence length by judge and offense",
             x = "", y = "Median Sentence min/max (days)",
             caption = "Only considering offenses with a disposition") + 
        scale_color_manual(values = c("lightgray","goldenrod3")) + 
        coord_flip() + 
        theme_minimal() + 
        theme(axis.text.x = element_text(angle=90, hjust=1,vjust=0.5))
    }
  }, res = 150)
  
  
  # Sentence plot by Race tab 3
  output$SenPlot3Output <- renderPlot({
    perct <- dispo_race() %>% 
      add_count(sentence_type, name = "sentence_ct") %>% 
      count(race, grade, sentence_type,sentence_ct, sort = TRUE) %>% 
      mutate(pct_sentence = n /sentence_ct) 
    
    ggplot(perct) +
      aes(x = grade, fill = race, weight = pct_sentence) +
      geom_bar(position = "dodge") +
      scale_fill_hue() +
      labs(y = "percentage") +
      theme_light() +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
      coord_flip() +
      facet_wrap(vars(sentence_type))
  }, res = 150)
  
  # Bail plot 1 (interactive): 
  output$BailPlot1Output <- renderGirafe({
    thematic_off()
    girafe_plot <- girafe(
      ggobj = bail_net_change_by_judge %>%
        ungroup() %>% 
        ggplot(aes(y=net_change, x=reorder(judge, -net_change), fill=n)) +
        geom_bar_interactive(
          aes(
            tooltip = glue("Judge: {judge}\nNet Change: {net_change}"),
            data_id = str_trim(str_remove_all(judge, "[:punct:]"))
          ),
          stat='identity', width=.5
        ) +
        labs(
          title = "Cumulative Total of Bail Increases and Decreases",
          x = "Judges",
          y = NULL,
          fill = "Total # of Bail Amount Changes"
        ) +
        xlab("Judges") +
        scale_x_discrete(labels = function(x) stringr::str_trunc(x, width=20)) + 
        theme(
          plot.caption = element_text(hjust = 0),
          axis.text.x = element_text(angle=90, hjust=1,vjust=0.5, size = 6)
        ),
      options = list(
        opts_tooltip(use_fill = TRUE),
        opts_selection(),
        opts_hover()
      ),
      width_svg = 24
    )
    thematic_on()
    girafe_plot
  })
  
  
  # Bail Plot 2:
  output$BailPlot2Output <- renderPlot({
    bail_filtered() %>%
      ggplot(aes(y=net_change, x=reorder(judge, -net_change), fill=n)) +
      geom_bar(stat='identity', width=.5) +
      labs(fill = "Total # of Bail Amount Changes") +
      xlab("Judges") +
      ylab("Cumulative Total of Bail Increases and Decreases") +
      theme(
        plot.caption = element_text(hjust = 0)
      )
  }, res = 150)
  
  
  
  # Debugging button - shinyapps.io asked me to disable this for deployment
  observeEvent(input$Debugger, {browser()})
  
  
  #
  # All the reactables ----
  #
  # Reactable for sentences plot 1
  output$TableOutputSentences1 <- renderReactable({
    reactable(filtered.data())
  })
  
  # Reactable for Judge tab 1, on row 2
  output$TableOutputJudge1 <- renderReactable({
    reactable(data_judge_filter())
  })
  
  # Reactable for Sentence tab 2, on row 2
  output$TableOutputSentences2 <- renderReactable({
    reactable(data_offense_filter())
  })
  
  # Reactable for Bail tab 
  output$TableOutputBail1 <- renderReactable({
    reactable(bail_filtered())
  })
  
}



shinyApp(ui, server)